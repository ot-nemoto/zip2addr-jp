name: Data check and open PR

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 1 * *" # monthly on day 1 at 06:00 UTC

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download data and compute sha
        run: |
          set -euo pipefail
          DATA_URL=https://www.post.japanpost.jp/zipcode/dl/utf/zip/utf_ken_all.zip
          echo "Downloading ${DATA_URL}"
          curl -sSL -o utf_ken_all.zip "$DATA_URL"
          sha256sum utf_ken_all.zip | awk '{print $1}' > utf_ken_all.sha256

      - name: Get previous checksum from latest release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          latest=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest" || true)
          echo "$latest" > latest.json
          prev_asset_url=$(echo "$latest" | jq -r '.assets[]? | select(.name=="utf_ken_all.sha256") | .url' || true)
          if [ -n "$prev_asset_url" ]; then
            curl -sL -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/octet-stream" "$prev_asset_url" -o prev_utf_ken_all.sha256 || true
          fi

      - name: Compare checksums and prepare files
        id: prepare
        run: |
          set -euo pipefail
          if [ -f prev_utf_ken_all.sha256 ] && cmp -s prev_utf_ken_all.sha256 utf_ken_all.sha256; then
            echo "no_change=true" >> $GITHUB_OUTPUT
            echo "No change in data; exiting"
            exit 0
          fi

          DATA_DATE=$(date +%Y%m%d)
          SHA=$(cat utf_ken_all.sha256 | tr -d '[:space:]')

          echo "Generating src/zip2addr/data_version.py"
          mkdir -p src/zip2addr
          printf "# generated by GitHub Actions\nDATA_DATE = \"%s\"\nDATA_SHA256 = \"%s\"\n" "$DATA_DATE" "$SHA" > src/zip2addr/data_version.py

          # Extract major.minor from pyproject.toml; fallback to 0.1
          if grep -q '^version' pyproject.toml; then
            MAJOR=$(grep '^version' pyproject.toml | sed -E 's/version\s*=\s*"([0-9]+)\.([0-9]+)\..*"/\1/' || echo 0)
            MINOR=$(grep '^version' pyproject.toml | sed -E 's/version\s*=\s*"([0-9]+)\.([0-9]+)\..*"/\2/' || echo 1)
          else
            MAJOR=0
            MINOR=1
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${DATA_DATE}"
          echo "Setting NEW_VERSION=${NEW_VERSION}"
          # replace version in pyproject.toml
          sed -E "s/^version\s*=.*/version = \"${NEW_VERSION}\"/" pyproject.toml > pyproject.toml.tmp
          mv pyproject.toml.tmp pyproject.toml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/zip2addr/data_version.py pyproject.toml
          git commit -m "chore(data): update data to ${DATA_DATE} (sha ${SHA})" || true
          echo "branch=data-update/${DATA_DATE}" >> $GITHUB_OUTPUT
          echo "data_date=${DATA_DATE}" >> $GITHUB_OUTPUT
          echo "data_sha=${SHA}" >> $GITHUB_OUTPUT
      - name: Clean working tree (remove downloads)
        if: ${{ steps.prepare.outputs.no_change != 'true' }}
        run: |
          # remove untracked files like downloaded zips so they aren't accidentally included
          git clean -fd

      - name: Validate data_date
        if: ${{ steps.prepare.outputs.no_change != 'true' }}
        run: |
          echo "prepare outputs: data_date='${{ steps.prepare.outputs.data_date }}' data_sha='${{ steps.prepare.outputs.data_sha }}'"
          if [ -z "${{ steps.prepare.outputs.data_date }}" ]; then
            echo "ERROR: data_date is empty â€” aborting to avoid creating invalid branch name"
            exit 1
          fi

      - name: Create Issue reporting data update
        if: ${{ steps.prepare.outputs.no_change != 'true' }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const data_date = context.payload.workflow_run ? context.payload.workflow_run.head_commit.timestamp : ''
            const title = `chore(data): update postal data to ${process.env.STEPS_PREPARE_OUTPUTS_DATA_DATE || '${{ steps.prepare.outputs.data_date }}'}`
            const body = `This issue was created by the data-check workflow.\n\nData date: ${{ steps.prepare.outputs.data_date }}\nSHA256: ${{ steps.prepare.outputs.data_sha }}\n`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['data-update']
            })
